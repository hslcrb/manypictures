name: Deploy & Release / 배포 및 릴리스

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-binaries:
    name: Build Binaries (${{ matrix.os }}) / 바이너리 빌드 (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository / 저장소 체크아웃
        uses: actions/checkout@v4

      - name: Install dependencies (Linux) / 의존성 설치 (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libcairo2-dev build-essential pkg-config

      - name: Install dependencies (macOS) / 의존성 설치 (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cairo xquartz pkg-config

      - name: Install dependencies (Windows) / 의존성 설치 (Windows)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cairo mingw-w64-x86_64-pkg-config make

      - name: Build (Linux/macOS) / 빌드 (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: make release

      - name: Build (Windows) / 빌드 (Windows)
        if: matrix.os == 'windows-latest'
        shell: msys2 {0}
        run: make release

      - name: Upload Artifacts / 산출물 업로드
        uses: actions/upload-artifact@v4
        with:
          name: manypictures-${{ matrix.os }}
          path: build/bin/manypictures*

  docker-push:
    name: Docker Build & Push / 도커 빌드 및 푸시
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    needs: build-binaries
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout repository / 저장소 체크아웃
        uses: actions/checkout@v4

      - name: Log in to the Container registry / 컨테이너 레지스트리 로그인
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker / 도커 메타데이터 추출
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push Docker image / 도커 이미지 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
附录一 算法及源码


  release:
    name: Create Release / 릴리스 생성
    runs-on: ubuntu-latest
    needs: [build-binaries, docker-push]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts / 모든 산출물 다운로드
        uses: actions/download-artifact@v4

      - name: Prepare Release Assets / 릴리스 자산 준비
        run: |
          mkdir assets
          cp manypictures-ubuntu-latest/manypictures assets/manypictures-linux
          cp manypictures-macos-latest/manypictures assets/manypictures-macos
          cp manypictures-windows-latest/manypictures.exe assets/manypictures-windows.exe

      - name: Release / 릴리스
        uses: softprops/action-gh-release@v1
        with:
          files: assets/*
          generate_release_notes: true
